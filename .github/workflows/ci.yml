name: AutomationPlatform CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

  workflow_dispatch:
    inputs:
      mode:
        description: "What to run"
        required: true
        default: "smoke"
        type: choice
        options:
          - smoke
          - full
      sync_bom:
        description: "After tests pass, sync deps -> bom and push changes (master only)"
        required: true
        default: false
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    concurrency:
      group: pages
      cancel-in-progress: false

    # Prevent infinite loops when the workflow auto-commits with [skip ci]
    if: >
      github.event_name != 'push' ||
      (github.event.head_commit.message && !contains(github.event.head_commit.message, '[skip ci]'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Run tests (push/PR default behavior)
        if: github.event_name != 'workflow_dispatch'
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            mvn -q test -Dgroups=smoke
          else
            mvn -q clean install
          fi

      - name: Run tests (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ inputs.mode }}" = "smoke" ]; then
            mvn -q test -Dgroups=smoke
          else
            mvn -q clean install
          fi

      # Optional guardrail: on normal pushes, you can verify BOM is in sync without auto-committing.
      # If you want this, uncomment the next block.
      # - name: Sync deps -> bom (check only)
      #   if: github.event_name != 'workflow_dispatch'
      #   run: |
      #     ./scripts/sync-versions-deps-to-bom.sh
      #     git diff --exit-code

      - name: Sync deps -> bom (manual, with optional push)
        if: github.event_name == 'workflow_dispatch'
        run: |
          ./scripts/sync-versions-deps-to-bom.sh

      - name: Commit & push BOM changes (manual, master only)
        if: >
          github.event_name == 'workflow_dispatch' &&
          inputs.sync_bom == true &&
          github.ref_name == 'master'
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add automationplatform-bom/pom.xml
          git commit -m "chore(bom): sync versions from deps [skip ci]"
          git push origin master

      - name: Generate Allure HTML report
        if: always()
        run: mvn -pl automationplatform-core -DskipTests allure:report

      - name: Upload Allure results (core)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: |
                **/target/allure-results/**
          if-no-files-found: ignore

      - name: Upload Allure HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: |
            automationplatform-core/target/site/allure-maven-plugin/**
          if-no-files-found: ignore

      - name: Prepare Allure Pages content
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          REPORT_DIR="automationplatform-core/target/site/allure-maven-plugin"
          OUT_DIR="public/allure"

          RUN_ID="${{ github.run_id }}"

          rm -rf public
          mkdir -p "${OUT_DIR}/runs/${RUN_ID}"
          cp -R "${REPORT_DIR}/." "${OUT_DIR}/runs/${RUN_ID}/"

          # master latest
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_name }}" == "master" ]]; then
            mkdir -p "${OUT_DIR}/latest"
            cp -R "${REPORT_DIR}/." "${OUT_DIR}/latest/"
          fi

          # PR latest (note: this deploy replaces the site content)
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
            mkdir -p "${OUT_DIR}/latest/pr-${PR_NUMBER}"
            cp -R "${REPORT_DIR}/." "${OUT_DIR}/latest/pr-${PR_NUMBER}/"
          fi

          cat > public/index.html <<'HTML'
          <!doctype html>
          <html>
            <head>
              <meta charset="utf-8" />
              <meta http-equiv="refresh" content="0; url=./allure/latest/" />
              <title>AutomationPlatform Reports</title>
            </head>
            <body>
              <p>Redirecting to <a href="./allure/latest/">Allure latest report</a>â€¦</p>
            </body>
          </html>
          HTML

      - name: Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        if: always()
        id: deployment
        uses: actions/deploy-pages@v4

