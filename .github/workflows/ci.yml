name: AutomationPlatform CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

  workflow_dispatch:
    inputs:
      mode:
        description: "What to run"
        required: true
        default: "smoke"
        type: choice
        options:
          - smoke
          - full
      sync_bom:
        description: "After tests pass, sync deps -> bom and push changes (master only)"
        required: true
        default: false
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    concurrency:
      group: pages
      cancel-in-progress: false

    # Prevent infinite loops when the workflow auto-commits with [skip ci]
    if: >
      github.event_name != 'push' ||
      (github.event.head_commit.message && !contains(github.event.head_commit.message, '[skip ci]'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Run tests (push/PR default behavior)
        if: github.event_name != 'workflow_dispatch'
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            mvn -q test -Djunit.jupiter.tags=smoke
          else
            mvn -q clean install
          fi

      - name: Run tests (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ inputs.mode }}" = "smoke" ]; then
            mvn -q test -Djunit.jupiter.tags=smoke
          else
            mvn -q clean install
          fi

      # Optional guardrail: on normal pushes, you can verify BOM is in sync without auto-committing.
      - name: Sync deps -> bom (check only)
        if: github.event_name != 'workflow_dispatch'
        run: |
           ./scripts/sync-versions-deps-to-bom.sh
           git diff --exit-code

      - name: Sync deps -> bom (manual, master only)
        if: >
          github.event_name == 'workflow_dispatch' &&
          inputs.sync_bom == true &&
          github.ref_name == 'master'
        run: |
          bash scripts/sync-versions-deps-to-bom.sh
      

      - name: Commit & push BOM changes (manual, master only)
        if: >
          github.event_name == 'workflow_dispatch' &&
          inputs.sync_bom == true &&
          github.ref_name == 'master'
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add automationplatform-bom/pom.xml
          git commit -m "chore(bom): sync versions from deps [skip ci]"
          git push origin master

      - name: Generate Allure HTML report
        if: always()
        run: mvn -DskipTests -Pallure verify

      - name: Upload Allure results (core)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: |
                target/allure-results/**
          if-no-files-found: ignore

      - name: Upload Allure HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: |
            target/allure-report/**
          if-no-files-found: ignore

      - name: Prepare Allure Pages content
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          REPORT_DIR="target/allure-report"
          OUT_DIR="public/allure"

          RUN_ID="${{ github.run_id }}"
          REPO="${{ github.repository }}"
          EVENT="${{ github.event_name }}"
          REF_NAME="${{ github.ref_name }}"

          rm -rf public
          mkdir -p "${OUT_DIR}/runs/${RUN_ID}"
          cp -R "${REPORT_DIR}/." "${OUT_DIR}/runs/${RUN_ID}/"

          # master latest
          if [[ "${EVENT}" == "push" && "${REF_NAME}" == "master" ]]; then
            mkdir -p "${OUT_DIR}/latest"
            cp -R "${REPORT_DIR}/." "${OUT_DIR}/latest/"
          fi

          # PR latest
          PR_NUMBER=""
          if [[ "${EVENT}" == "pull_request" ]]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
            mkdir -p "${OUT_DIR}/latest/pr-${PR_NUMBER}"
            cp -R "${REPORT_DIR}/." "${OUT_DIR}/latest/pr-${PR_NUMBER}/"
          fi

          # build optional links
          MASTER_LATEST_LI=""
          if [[ "${EVENT}" == "push" && "${REF_NAME}" == "master" ]]; then
            MASTER_LATEST_LI='<li><a href="./allure/latest/">Latest (master)</a></li>'
          fi

          PR_LATEST_LI=""
          if [[ -n "${PR_NUMBER}" ]]; then
            PR_LATEST_LI="<li><a href=\"./allure/latest/pr-${PR_NUMBER}/\">Latest (PR #${PR_NUMBER})</a></li>"
          fi

          cat > public/index.html <<HTML
          <!doctype html>
          <html lang="en">
            <head>
              <meta charset="utf-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1" />
              <title>${REPO} â€“ Test Reports</title>
              <style>
                body {
                  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
                  margin: 40px;
                  line-height: 1.4;
                }
                .card {
                  max-width: 820px;
                  padding: 22px;
                  border: 1px solid #e5e7eb;
                  border-radius: 14px;
                }
                h1 { margin: 0 0 6px; font-size: 22px; }
                p { margin: 8px 0; color: #374151; }
                ul { margin: 14px 0 0; padding-left: 18px; }
                li { margin: 8px 0; }
                a { color: #2563eb; text-decoration: none; }
                a:hover { text-decoration: underline; }
                code {
                  background: #f3f4f6;
                  padding: 2px 6px;
                  border-radius: 6px;
                }
                .meta {
                  margin-top: 14px;
                  color: #6b7280;
                  font-size: 13px;
                }
              </style>
            </head>
            <body>
              <div class="card">
                <h1>${REPO} â€“ Allure Test Reports</h1>
                <p>Reports published automatically from GitHub Actions.</p>

                <ul>
                  ${MASTER_LATEST_LI}
                  <li><a href="./allure/runs/${RUN_ID}/">This run (${RUN_ID})</a></li>
                  ${PR_LATEST_LI}
                </ul>

                <div class="meta">
                  Event: <code>${EVENT}</code> â€¢ Ref: <code>${REF_NAME}</code>
                </div>
              </div>
            </body>
          </html>
          HTML

      - name: Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        if: always()
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Add report link to job summary
        if: always()
        shell: bash
        run: |
          echo "## ðŸ“Š Test Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Allure landing page:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Master latest:** ${{ steps.deployment.outputs.page_url }}allure/latest/" >> $GITHUB_STEP_SUMMARY
          echo "- **This run:** ${{ steps.deployment.outputs.page_url }}allure/runs/${{ github.run_id }}/" >> $GITHUB_STEP_SUMMARY
  
